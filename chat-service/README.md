# Chat Service API

Сервис чата для такси-платформы, обеспечивающий коммуникацию между водителями, пассажирами и администраторами.

## Содержание

- [Общие сведения](#общие-сведения)
- [Типы чатов](#типы-чатов)
- [REST API](#rest-api)
- [WebSocket API](#websocket-api)
- [Потоки данных](#потоки-данных)
- [Статусы сообщений](#статусы-сообщений)
- [Вложения](#вложения)

## Общие сведения

Сервис чата позволяет создавать различные типы чатов между участниками системы:

- Водитель-пассажир (в рамках поездки)
- Водитель-администратор
- Пассажир-администратор
- Групповые чаты

Система поддерживает:

- Обмен текстовыми сообщениями
- Статусы сообщений (отправлено, доставлено, прочитано)
- Вложения файлов
- Общение в реальном времени через WebSocket
- События "печатает"
- Архивацию и удаление сообщений

## Типы чатов

| Тип чата          | Описание                                | Особенности                                         |
| ----------------- | --------------------------------------- | --------------------------------------------------- |
| `ride`            | Чат между водителем и пассажиром        | Привязан к конкретной поездке (обязателен `rideId`) |
| `driver_admin`    | Чат между водителем и администратором   | Не привязан к поездке, для общих вопросов           |
| `passenger_admin` | Чат между пассажиром и администратором  | Для поддержки пассажиров                            |
| `group`           | Групповой чат с несколькими участниками | Требует хотя бы одного администратора               |

## REST API

### Аутентификация

Все запросы должны содержать токен JWT в заголовке:

```
Authorization: Bearer {token}
```

### Отправка сообщения

```
POST /chats
```

**Тело запроса**:

```json
{
  "receiverId": "passenger:123",
  "text": "Сообщение",
  "rideId": "456"
}
```

**Ответ**:

```json
{
  "success": true,
  "data": {
    "id": "msg789",
    "content": "Сообщение",
    "sender_id": "driver:123",
    "receiver_id": "passenger:456",
    "chat_id": "chat123",
    "status": "sent",
    "createdAt": "2023-01-01T12:00:00Z"
  }
}
```

### Получение истории чата

```
GET /chats?rideId={rideId}
```

или

```
GET /chats?chatId={chatId}
```

**Ответ**:

```json
{
  "success": true,
  "data": [
    {
      "id": "msg123",
      "content": "Привет! Я уже рядом с домом.",
      "sender_id": "driver:123",
      "receiver_id": "passenger:456",
      "status": "read",
      "timestamp": "2023-01-01T12:00:00Z"
    },
    {
      "id": "msg124",
      "content": "Отлично, выхожу!",
      "sender_id": "passenger:456",
      "receiver_id": "driver:123",
      "status": "sent",
      "timestamp": "2023-01-01T12:01:00Z"
    }
  ]
}
```

### Создание чата между водителем и администратором

```
POST /chats/driver-admin
```

**Тело запроса**:

```json
{
  "driverId": "123",
  "adminId": "456"
}
```

**Ответ**:

```json
{
  "success": true,
  "data": {
    "id": "chat789",
    "type": "driver_admin",
    "participantIds": ["driver:123", "admin:456"],
    "createdAt": "2023-01-01T12:00:00Z"
  }
}
```

### Получение чатов между водителем и администратором

```
GET /chats/driver-admin
```

**Ответ**:

```json
{
  "success": true,
  "data": [
    {
      "id": "chat789",
      "participantIds": ["driver:123", "admin:456"],
      "createdAt": "2023-01-01T12:00:00Z"
    }
  ]
}
```

### Создание чата между пассажиром и администратором

```
POST /chats/passenger-admin
```

**Тело запроса**:

```json
{
  "passengerId": "123",
  "adminId": "456"
}
```

**Ответ**:

```json
{
  "success": true,
  "data": {
    "id": "chat789",
    "type": "passenger_admin",
    "participantIds": ["passenger:123", "admin:456"],
    "createdAt": "2023-01-01T12:00:00Z"
  }
}
```

### Получение чатов между пассажиром и администратором

```
GET /chats/passenger-admin
```

**Ответ**:

```json
{
  "success": true,
  "data": [
    {
      "id": "chat789",
      "participantIds": ["passenger:123", "admin:456"],
      "createdAt": "2023-01-01T12:00:00Z"
    }
  ]
}
```

### Создание группового чата

```
POST /chats/group
```

**Тело запроса**:

```json
{
  "name": "Поддержка поездки #123",
  "participantIds": ["driver:123", "passenger:456", "admin:789"]
}
```

**Ответ**:

```json
{
  "success": true,
  "data": {
    "id": "chat789",
    "type": "group",
    "name": "Поддержка поездки #123",
    "participantIds": ["driver:123", "passenger:456", "admin:789"],
    "createdAt": "2023-01-01T12:00:00Z"
  }
}
```

### Поиск сообщений

```
GET /chats/search?query={текст}&chatId={chatId}
```

**Параметры запроса**:

- `query` - текст для поиска
- `chatId` - (опционально) ID чата для поиска
- `dateFrom` - (опционально) начальная дата в ISO формате
- `dateTo` - (опционально) конечная дата в ISO формате
- `limit` - (опционально) количество результатов, по умолчанию 20
- `offset` - (опционально) смещение для пагинации, по умолчанию 0

**Ответ**:

```json
{
  "success": true,
  "data": {
    "total": 5,
    "limit": 20,
    "offset": 0,
    "query": "встреча",
    "results": [
      {
        "chatId": "chat123",
        "messages": [
          {
            "id": "msg456",
            "content": "Встреча в 15:00 подтверждена",
            "sender_id": "admin:123",
            "timestamp": "2023-01-01T12:00:00Z"
          }
        ]
      }
    ]
  }
}
```

## WebSocket API

### Подключение

```javascript
const socket = io("http://localhost:3014", {
  auth: {
    token: "jwt_token_here",
  },
});
```

### События

#### Присоединение к чату поездки

**Отправка**:

```javascript
socket.emit("join_ride", rideId);
```

**Получение истории**:

```javascript
socket.on("chat_history", (messages) => {
  // Обработка истории сообщений
});
```

#### Присоединение к чату водитель-администратор

**Отправка**:

```javascript
socket.emit("join_driver_admin_chat", chatId);
```

#### Присоединение к чату пассажир-администратор

**Отправка**:

```javascript
socket.emit("join_passenger_admin_chat", chatId);
```

#### Присоединение к групповому чату

**Отправка**:

```javascript
socket.emit("join_group_chat", chatId);
```

#### Отправка сообщения

**Отправка**:

```javascript
socket.emit("send_message", {
  receiverId: "passenger:123",
  rideId: "456", // Если это чат поездки
  text: "Привет!",
  chatId: "chat789", // Для групповых чатов
});
```

**Получение нового сообщения**:

```javascript
socket.on("new_message", (message) => {
  // Обработка нового сообщения
});
```

#### Отметка о прочтении

**Отправка**:

```javascript
// Отметить одно сообщение
socket.emit("mark_as_read", { messageId: "msg123" });

// Отметить все сообщения в чате
socket.emit("mark_as_read", { chatId: "chat123" });
```

**Получение события о прочтении**:

```javascript
socket.on("message_read", (data) => {
  // Обработка события прочтения сообщения
  // data содержит messageId, senderId, receiverId, chatId, timestamp
});

socket.on("all_messages_read", (data) => {
  // Обработка события прочтения всех сообщений
  // data содержит chatId, userId, timestamp
});
```

#### Индикатор печати

**Отправка**:

```javascript
socket.emit("typing", { chatId: "chat123", isTyping: true });
```

**Получение**:

```javascript
socket.on("user_typing", (data) => {
  // data содержит userId, chatId, isTyping, timestamp
});
```

#### Обработка ошибок

```javascript
socket.on("error", (error) => {
  console.error(error.code, error.message);
});
```

## Потоки данных

### Сценарий 1: Общение пассажира и водителя в поездке

1. Система создает чат поездки при назначении водителя
2. Пассажир и водитель подключаются к WebSocket и присоединяются к комнате поездки
3. Обмен сообщениями в реальном времени между водителем и пассажиром
4. Возможность просматривать историю чата через REST API
5. После завершения поездки чат становится доступен только для чтения

### Сценарий 2: Обращение водителя в поддержку

1. Водитель создает чат с администратором через API или отправляет первое сообщение
2. Администратор получает уведомление о новом обращении
3. Обмен сообщениями между водителем и администратором
4. Возможность архивации чата после решения вопроса

## Статусы сообщений

| Статус      | Описание                                              |
| ----------- | ----------------------------------------------------- |
| `sent`      | Сообщение отправлено, но еще не доставлено получателю |
| `delivered` | Сообщение доставлено получателю, но еще не прочитано  |
| `read`      | Сообщение прочитано получателем                       |

## Вложения

Система поддерживает прикрепление файлов к сообщениям:

- Максимальный размер файла: 10 МБ
- Поддерживаемые форматы: изображения (JPEG, PNG, GIF), документы (PDF, DOC, DOCX, XLS, XLSX), архивы (ZIP, RAR)
- Возможность получить все вложения чата отдельным запросом
